<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Groups Chat App</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Inter Font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            /* Default background - will be overridden by React state */
            background-color: #f1f1f1;
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            transition: background-color 0.3s ease, background-image 0.3s ease;
        }
        /* Custom scrollbar for better aesthetics */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <!-- React CDN -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <!-- Babel Standalone for JSX transformation in browser -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Firebase CDN -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, addDoc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, query, where, getDocs, serverTimestamp, writeBatch } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // IMPORTANT: Replace the following placeholder values with your actual Firebase project configuration.
        // You can find these in your Firebase Project Settings -> "Your apps" section.
        const YOUR_FIREBASE_CONFIG = {
            apiKey: "AIzaSyA2ygZbOFBq9K4cNgpL4crKj5-RfN3u-9I", // CRITICAL: YOU MUST REPLACE "YOUR_API_KEY" WITH YOUR ACTUAL FIREBASE API KEY.
                                    //      This is the source of the "auth/api-key-not-valid" error.
                                    //      Find it in Firebase Console -> Project settings (gear icon) -> General -> Your apps -> Web App.
            authDomain: "my-chat-app-639c8.firebaseapp.com", // e.g., "my-chat-app-12345.firebaseapp.com"
            projectId: "my-chat-app-639c8", // e.g., "my-chat-app-12345"
            storageBucket: "my-chat-app-639c8.appspot.com",
            messagingSenderId: "1072114417951",
            appId: "1:1072114417951:web:52864b2162e8bc873bf02a" // e.g., "1:234567890:web:abcdef1234567890abcdef"
        };

        // You generally won't have an initialAuthToken when running standalone
        // unless you're implementing a custom authentication flow.
        // For local testing, anonymous sign-in will be used by default if null.
        const YOUR_INITIAL_AUTH_TOKEN = null; // Keep this as null for initial setup

        // Make Firebase functions and variables globally accessible for the Babel script
        // Firebase services are initialized ONLY ONCE here.
        window.firebaseApp = initializeApp(YOUR_FIREBASE_CONFIG);
        window.db = getFirestore(window.firebaseApp);
        window.auth = getAuth(window.firebaseApp);
        window.signInAnonymously = signInAnonymously;
        window.signInWithCustomToken = signInWithCustomToken;
        window.onAuthStateChanged = onAuthStateChanged;
        window.doc = doc;
        window.getDoc = getDoc;
        window.addDoc = addDoc;
        window.setDoc = setDoc;
        window.updateDoc = updateDoc;
        window.deleteDoc = deleteDoc;
        window.onSnapshot = onSnapshot;
        window.collection = collection;
        window.query = query;
        window.where = where;
        window.getDocs = getDocs;
        window.serverTimestamp = serverTimestamp;
        window.writeBatch = writeBatch; // Make writeBatch available
        // Use the projectId from your config as the appId for data separation
        window.appId = YOUR_FIREBASE_CONFIG.projectId;
        window.initialAuthToken = YOUR_INITIAL_AUTH_TOKEN;
    </script>

    <script type="text/babel">
        // Ensure React and ReactDOM are available globally
        const { useState, useEffect, useRef } = React;
        const { createRoot } = ReactDOM; // Use createRoot for React 18

        // Define inline SVG icons to replace Lucide React components
        const SendIcon = (props) => (
            <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="lucide lucide-send"><path d="m22 2-7 20-4-9-9-4 20-7Z"/><path d="M22 2 11 13"/></svg>
        );
        const PaperclipIcon = (props) => (
            <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="lucide lucude-paperclip"><path d="m21.44 11.05-9.19 9.19a6 6 0 0 1-8.49-8.49l9.19-9.19a4 4 0 0 1 5.66 5.66l-9.2 9.19a2 2 0 0 1-2.83-2.83l8.49-8.49"/></svg>
        );
        const ImageIcon = (props) => (
            <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="lucide lucide-image"><rect width="18" height="18" x="3" y="3" rx="2" ry="2"/><circle cx="9" cy="9" r="2"/><path d="m21 15-3.086-3.086a2 2 0 0 0-2.828 0L6 21"/></svg>
        );
        const VideoIcon = (props) => (
            <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="lucide lucide-video"><path d="m22 8-6 4 6 4V8Z"/><rect width="14" height="12" x="2" y="6" rx="2" ry="2"/></svg>
        );
        const FileTextIcon = (props) => (
            <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="lucide lucide-file-text"><path d="M15 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7Z"/><path d="M14 2v4a2 2 0 0 0 2 2h4"/><path d="M10 9H8"/><path d="M16 13H8"/><path d="M16 17H8"/></svg>
        );
        const XIcon = (props) => (
            <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="lucide lucide-x"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>
        );
        const DownloadIcon = (props) => (
            <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="lucide lucide-download"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/></svg>
        );
        const EditIcon = (props) => (
            <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="lucide lucide-edit"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2 0 0 1 3 3L12 15l-4 1 1-4Z"/></svg>
        );
        const KeyIcon = (props) => (
            <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="lucide lucide-key"><path d="M2 18v3c0 .6.4 1 1 1h4v-2h-3v-3.828L18.828 3.172a4 4 0 0 1 5.656 5.656L8.172 22H2v-4Z"/><path d="m17 7 3-3"/><path d="m14 10 3-3"/><path d="m7 17 3-3"/></svg>
        );
        const PaintbrushIcon = (props) => (
            <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="lucide lucide-paintbrush"><path d="M18.37 2.63c-1.3-.9-3.2-.58-4.1.72L7.6 14.23a2 2 0 0 0-.5 1.15l-.13 1.25H3a1 1 0 0 0 0 2h3.5L4.1 20.9A2 2 0 0 0 5.23 22h1.54a2 2 0 0 0 1.5-3.3L15.3 5.37c.9-1.3.58-3.2-.72-4.1Z"/><path d="M14.5 19.5 22 12"/></svg>
        );
        const Wand2Icon = (props) => (
            <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="lucide lucide-wand-2"><path d="m21 7-2 2-3-3 2-2Z"/><path d="M10 13a5 5 0 1 0 6 6l-3 3-2-2Z"/><path d="m2 22 1-1"/><path d="m11 11 2 2"/><path d="m15 5 2 2"/></svg>
        );
        const BellIcon = (props) => (
            <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="lucide lucide-bell"><path d="M6 8a6 6 0 0 1 12 0c0 7 3 9 3 9H3s3-2 3-9"/><path d="M10.36 14h3.28"/></svg>
        );
        const BellOffIcon = (props) => (
            <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="lucide lucide-bell-off"><path d="M8.27 1.343A6 6 0 0 1 18 8c0 2.22-1.22 4.16-3 5.54M3 21h18"/><path d="M12 21v-4"/><path d="M4.32 8.32a6 6 0 0 1 8.7-7M2 2l20 20"/></svg>
        );
        const UserIcon = (props) => (
            <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="lucide lucide-user"><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
        );
        const UsersIcon = (props) => (
            <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="lucide lucide-users"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>
        );
        const Trash2Icon = (props) => (
            <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="lucide lucide-trash-2"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></svg>
        );


        const App = () => {
            const [db, setDb] = useState(null);
            const [auth, setAuth] = useState(null);
            // authenticatedUserId is the UID provided by Firebase Authentication (auth.currentUser.uid)
            const [authenticatedUserId, setAuthenticatedUserId] = useState(null);
            // activeDataUserId is the ID used for Firestore paths and displayed to the user.
            // It can be overridden by a user-entered "preferred" ID.
            const [activeDataUserId, setActiveDataUserId] = useState(null);
            const [isAuthReady, setIsAuthReady] = useState(false);
            const [contacts, setContacts] = useState([]);
            const [groups, setGroups] = useState([]);
            const [selectedChat, setSelectedChat] = useState(null);
            const [messages, setMessages] = useState([]);
            const [newMessage, setNewMessage] = useState('');
            const [showAddContactModal, setShowAddContactModal] = useState(false);
            const [newContactId, setNewContactId] = useState('');
            const [callStatus, setCallStatus] = useState(null);
            const messagesEndRef = useRef(null);
            const fileInputRef = useRef(null);
            // Ref to store the previous messages count for notification logic
            const prevMessagesCount = useRef(0);

            const [showCreateGroupModal, setShowCreateGroupModal] = useState(false);
            const [newGroupName, setNewGroupName] = useState('');
            const [selectedGroupMembers, setSelectedGroupMembers] = useState([]);

            const [showConfirmDeleteContactModal, setShowConfirmDeleteContactModal] = useState(false);
            const [contactToDelete, setContactToDelete] = useState(null);
            const [showConfirmDeleteAllContactsModal, setShowConfirmDeleteAllContactsModal] = useState(false);

            const [showEditContactNameModal, setShowEditContactNameModal] = useState(false);
            const [editingContact, setEditingContact] = useState(null);
            const [newContactDisplayName, setNewContactDisplayName] = useState('');

            const [showApiKeyModal, setShowApiKeyModal] = useState(false);
            const [userApiKey, setUserApiKey] = useState(localStorage.getItem('geminiApiKey') || '');

            // State for AI-generated logo
            const [logoUrl, setLogoUrl] = useState(localStorage.getItem('appLogoUrl') || null);
            const [isLoadingLogo, setIsLoadingLogo] = useState(false);

            // State for background customization
            const [backgroundColor, setBackgroundColor] = useState(localStorage.getItem('appBackgroundColor') || '#f1f1f1');
            const [backgroundImage, setBackgroundImage] = useState(localStorage.getItem('appBackgroundImage') || '');
            const [showBackgroundSettingsModal, setShowBackgroundSettingsModal] = useState(false);

            // Notification States
            // Initialize notifications state based on localStorage AND browser permission
            const [areNotificationsEnabled, setAreNotificationsEnabled] = useState(() => {
                const stored = localStorage.getItem('areNotificationsEnabled');
                // Only enable in-app if it was stored as true AND browser grants permission
                return stored === 'true' && Notification.permission === 'granted';
            });
            const audioContextRef = useRef(null);

            // State for custom system messages
            const [systemMessage, setSystemMessage] = useState(null);

            // State for "Switch User ID" feature
            const [showSwitchIdModal, setShowSwitchIdModal] = useState(false);
            const [newPreferredUserIdInput, setNewPreferredUserIdInput] = useState('');

            // New states for Group Management
            const [showConfirmDeleteGroupModal, setShowConfirmDeleteGroupModal] = useState(false);
            const [groupToDelete, setGroupToDelete] = useState(null);
            const [showEditGroupMembersModal, setShowEditGroupMembersModal] = useState(false);
            const [editingGroup, setEditingGroup] = useState(null);
            const [currentGroupMembersInModal, setCurrentGroupMembersInModal] = useState([]);


            // Function to show custom message
            const showSystemMessage = (message, type = 'info') => {
                setSystemMessage({ message, type });
                setTimeout(() => setSystemMessage(null), 5000); // Clear after 5 seconds
            };


            // Initialize Firebase and handle authentication
            useEffect(() => {
                setDb(window.db);
                setAuth(window.auth);

                const unsubscribe = window.onAuthStateChanged(window.auth, async (user) => {
                    let currentAuthId;
                    if (user) {
                        currentAuthId = user.uid;
                        setAuthenticatedUserId(user.uid);
                    } else {
                        if (window.initialAuthToken) {
                            try {
                                await window.signInWithCustomToken(window.auth, window.initialAuthToken);
                                currentAuthId = window.auth.currentUser.uid;
                                setAuthenticatedUserId(window.auth.currentUser.uid);
                            } catch (error) {
                                console.warn("Custom authentication token failed, falling back to anonymous sign-in:", error);
                                await window.signInAnonymously(window.auth);
                                currentAuthId = window.auth.currentUser.uid;
                                setAuthenticatedUserId(window.auth.currentUser.uid);
                            }
                        } else {
                            await window.signInAnonymously(window.auth);
                            currentAuthId = window.auth.currentUser.uid;
                            setAuthenticatedUserId(window.auth.currentUser.uid);
                        }
                    }

                    // Determine the activeDataUserId
                    const storedPreferredId = localStorage.getItem('preferredUserId');
                    if (storedPreferredId) {
                        setActiveDataUserId(storedPreferredId);
                    } else {
                        // If no preferred ID is stored, use the authenticated ID as default
                        setActiveDataUserId(currentAuthId);
                        localStorage.setItem('preferredUserId', currentAuthId);
                    }

                    setIsAuthReady(true);
                });

                // Initialize AudioContext only once. It will be suspended initially by browsers.
                // It will be resumed on the first user interaction (e.g., clicking notification toggle).
                if (!audioContextRef.current) {
                    try {
                        audioContextRef.current = new (window.AudioContext || window.webkitAudioContext)();
                    } catch (e) {
                        console.warn("Web Audio API not supported or error:", e);
                    }
                }

                return () => {
                    unsubscribe();
                    if (audioContextRef.current && audioContextRef.current.state !== 'closed') {
                        audioContextRef.current.close().catch(e => console.error("Error closing AudioContext:", e));
                    }
                };
            }, []);

            // Function to play the ding sound
            const playDingSound = () => {
                if (audioContextRef.current && areNotificationsEnabled) {
                    // Ensure context is running if it was suspended
                    if (audioContextRef.current.state === 'suspended') {
                        audioContextRef.current.resume().catch(e => console.error("Error resuming AudioContext:", e));
                    }

                    const oscillator = audioContextRef.current.createOscillator();
                    const gainNode = audioContextRef.current.createGain();

                    oscillator.connect(gainNode);
                    gainNode.connect(audioContextRef.current.destination);

                    oscillator.type = 'sine';
                    oscillator.frequency.setValueAtTime(880, audioContextRef.current.currentTime); // A5 note
                    gainNode.gain.setValueAtTime(0.5, audioContextRef.current.currentTime);

                    // Fade out the sound quickly
                    gainNode.gain.exponentialRampToValueAtTime(0.001, audioContextRef.current.currentTime + 0.3); // 0.3 seconds ding

                    oscillator.start(audioContextRef.current.currentTime);
                    oscillator.stop(audioContextRef.current.currentTime + 0.5); // Stop after 0.5 seconds to clean up
                }
            };

            // Function to show a browser notification
            const showNewMessageNotification = (message, senderDisplayName, chatName) => {
                // Only show if notifications are enabled AND browser permission is granted
                // AND the current tab is NOT visible (i.e., user is on another tab or app)
                if (areNotificationsEnabled && Notification.permission === 'granted' && document.visibilityState !== 'visible') {
                    const title = `New message in ${chatName}`;
                    const options = {
                        body: `${senderDisplayName}: ${message}`,
                        icon: logoUrl || 'https://placehold.co/48x48/8A2BE2/FFFFFF?text=G', // Use generated logo or fallback
                        // Add a tag to prevent multiple notifications from stacking.
                        // If a new message comes from the same chat, it will replace the previous notification.
                        tag: selectedChat ? `chat-${selectedChat.id}` : 'new-message', // Use selectedChat.id for specific chat tagging
                        renotify: true // Ensure the notification is shown again if new content arrives with the same tag
                    };
                    new Notification(title, options);
                }
            };

            // Toggle notifications on/off
            const toggleNotifications = async () => {
                const currentEnabledStateInApp = areNotificationsEnabled; // What the app *thinks* is enabled
                const browserPermission = Notification.permission; // What the browser *actually* reports

                // Attempt to resume audio context on *any* user interaction with the button
                if (audioContextRef.current && audioContextRef.current.state === 'suspended') {
                    audioContextRef.current.resume().catch(e => console.error("Error resuming AudioContext on toggle:", e));
                }

                if (!currentEnabledStateInApp) { // User wants to turn notifications ON (app state is currently OFF)
                    showSystemMessage(`Browser reports notification permission as '${browserPermission}'.`, 'info');
                    if (browserPermission === 'default') {
                        const permissionResult = await Notification.requestPermission();
                        if (permissionResult === 'granted') {
                            setAreNotificationsEnabled(true);
                            localStorage.setItem('areNotificationsEnabled', 'true');
                            showSystemMessage("Notifications are now ON and granted by browser.", 'success');
                        } else {
                            setAreNotificationsEnabled(false);
                            localStorage.setItem('areNotificationsEnabled', 'false');
                            showSystemMessage("Notification permission denied. Please enable manually in browser settings.", 'warning');
                        }
                    } else if (browserPermission === 'granted') {
                        // Browser already granted, just need to turn ON in-app state
                        setAreNotificationsEnabled(true);
                        localStorage.setItem('areNotificationsEnabled', 'true');
                        showSystemMessage("Notifications are now ON (browser already granted).", 'info');
                    } else if (browserPermission === 'denied') {
                        // Browser explicitly denied, cannot re-prompt
                        setAreNotificationsEnabled(false);
                        localStorage.setItem('areNotificationsEnabled', 'false');
                        showSystemMessage("Notifications are blocked by your browser settings. Please enable them manually in your browser settings to receive notifications.", 'error');
                    }
                } else { // User wants to turn notifications OFF (app state is currently ON)
                    setAreNotificationsEnabled(false);
                    localStorage.setItem('areNotificationsEnabled', 'false');
                    showSystemMessage("Notifications are now OFF.", 'info');
                }
            };


            // Apply background styles to the body
            useEffect(() => {
                const body = document.body;
                if (backgroundImage) {
                    body.style.backgroundImage = `url('${backgroundImage}')`;
                    body.style.backgroundColor = 'transparent'; // Ensure background color doesn't show through
                } else {
                    body.style.backgroundImage = 'none';
                    body.style.backgroundColor = backgroundColor;
                }
            }, [backgroundColor, backgroundImage]);


            // Fetch contacts when auth is ready and activeDataUserId is available
            useEffect(() => {
                if (db && authenticatedUserId && isAuthReady) {
                    // Note: Contacts are private and tied to the AUTHENTICATED user ID for security rules.
                    // If activeDataUserId is different from authenticatedUserId, fetching contacts might fail.
                    const contactsRef = window.collection(db, `artifacts/${window.appId}/users/${authenticatedUserId}/contacts`);
                    const unsubscribe = window.onSnapshot(contactsRef, (snapshot) => {
                        const fetchedContacts = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data(), type: 'individual' }));
                        setContacts(fetchedContacts);
                    }, (error) => {
                        console.error("Error fetching contacts:", error);
                        showSystemMessage("Error fetching contacts. Ensure your active User ID matches your authenticated ID if you're experiencing issues.", 'error');
                    });

                    return () => unsubscribe();
                }
            }, [db, authenticatedUserId, isAuthReady]); // Removed activeDataUserId from dependency array for contacts as it should be based on auth ID

            // Fetch groups that the user is a member of (using activeDataUserId)
            useEffect(() => {
                if (db && activeDataUserId && isAuthReady) {
                    const groupsRef = window.collection(db, `artifacts/${window.appId}/public/data/groups`);
                    // Query uses activeDataUserId because groups are public and members can be any ID
                    const q = window.query(groupsRef, window.where("members", "array-contains", activeDataUserId));

                    const unsubscribe = window.onSnapshot(q, (snapshot) => {
                        const fetchedGroups = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data(), type: 'group' }));
                        setGroups(fetchedGroups);
                    }, (error) => {
                        console.error("Error fetching groups:", error);
                    });

                    return () => unsubscribe();
                }
            }, [db, activeDataUserId, isAuthReady]);

            // Fetch messages for the selected chat (individual or group)
            useEffect(() => {
                if (db && activeDataUserId && selectedChat && isAuthReady) {
                    let messagesRef;
                    if (selectedChat.type === 'individual') {
                        // Conversation ID uses activeDataUserId for consistency
                        const conversationId = [activeDataUserId, selectedChat.contactId].sort().join('_');
                        messagesRef = window.collection(db, `artifacts/${window.appId}/public/data/messages/${conversationId}/messages`);
                    } else if (selectedChat.type === 'group') {
                        messagesRef = window.collection(db, `artifacts/${window.appId}/public/data/groups/${selectedChat.id}/messages`);
                    }

                    const q = window.query(messagesRef);

                    const unsubscribe = window.onSnapshot(q, (snapshot) => {
                        const fetchedMessages = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                        fetchedMessages.sort((a, b) => (a.timestamp?.toMillis() || 0) - (b.timestamp?.toMillis() || 0));

                        // Check for new messages and trigger notifications/sound
                        if (fetchedMessages.length > prevMessagesCount.current) {
                            const newMessages = fetchedMessages.slice(prevMessagesCount.current);
                            newMessages.forEach(msg => {
                                // Only notify for messages not sent by current user
                                // And only if the user is not currently in this chat or tab is not focused
                                if (msg.senderId !== activeDataUserId) {
                                    playDingSound();
                                    const chatName = selectedChat.type === 'individual'
                                        ? (contacts.find(c => c.contactId === selectedChat.contactId)?.displayName || selectedChat.contactId)
                                        : selectedChat.name;
                                    showNewMessageNotification(msg.text, msg.senderId, chatName);
                                }
                            });
                        }
                        prevMessagesCount.current = fetchedMessages.length; // Update the ref for next comparison

                        setMessages(fetchedMessages);
                    }, (error) => {
                        console.error("Error fetching messages:", error);
                    });

                    return () => unsubscribe();
                } else {
                    setMessages([]);
                    prevMessagesCount.current = 0; // Reset count when chat changes
                }
            }, [db, activeDataUserId, selectedChat, isAuthReady, contacts, groups, areNotificationsEnabled, logoUrl]);


            // Scroll to the latest message
            useEffect(() => {
                messagesEndRef.current?.scrollIntoView({ behavior: 'smooth' });
            }, [messages]);

            const handleSendMessage = async (attachment = null) => {
                if (!db || !activeDataUserId || !selectedChat || (!newMessage.trim() && !attachment)) return;

                let messagesCollectionRef;
                let messageData = {
                    // senderId uses activeDataUserId
                    senderId: activeDataUserId,
                    timestamp: window.serverTimestamp(),
                };

                if (selectedChat.type === 'individual') {
                    const conversationId = [activeDataUserId, selectedChat.contactId].sort().join('_');
                    messagesCollectionRef = window.collection(db, `artifacts/${window.appId}/public/data/messages/${conversationId}/messages`);
                    messageData.receiverId = selectedChat.contactId;
                } else if (selectedChat.type === 'group') {
                    messagesCollectionRef = window.collection(db, `artifacts/${window.appId}/public/data/groups/${selectedChat.id}/messages`);
                    messageData.groupId = selectedChat.id;
                }

                if (attachment) {
                    messageData.type = 'attachment';
                    messageData.attachment = attachment;
                    messageData.text = '';
                } else {
                    messageData.type = 'text';
                    messageData.text = newMessage;
                }

                try {
                    await window.addDoc(messagesCollectionRef, messageData);
                    setNewMessage('');
                    if (fileInputRef.current) {
                        fileInputRef.current.value = '';
                    }
                } catch (error) {
                    console.error("Error sending message:", error);
                    console.log("Error sending file: File might be too large (over ~750KB). Firestore documents have a 1MB limit.");
                    showSystemMessage("Error sending message. File might be too large or other issue. Check console.", 'error');
                }
            };

            const handleFileChange = (event) => {
                const file = event.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        const base64Content = e.target.result;
                        const attachmentData = {
                            name: file.name,
                            type: file.type || 'application/octet-stream',
                            size: file.size,
                            data: base64Content,
                        };
                        handleSendMessage(attachmentData);
                    };
                    reader.readAsDataURL(file);
                }
            };

            const handleDownloadAttachment = (attachment) => {
                if (!attachment || !attachment.data || !attachment.name || !attachment.type) {
                    console.error("Invalid attachment data for download.");
                    showSystemMessage("Invalid attachment data for download.", 'error');
                    return;
                }

                const byteCharacters = atob(attachment.data.split(',')[1]);
                const byteNumbers = new Array(byteCharacters.length);
                for (let i = 0; i < byteCharacters.length; i++) {
                    byteNumbers[i] = byteCharacters.charCodeAt(i);
                }
                const byteArray = new Uint8Array(byteNumbers);
                const blob = new Blob([byteArray], { type: attachment.type });

                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = attachment.name;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            };


            const handleAddContact = async () => {
                // For contacts, we must use the authenticatedUserId for security rules
                if (!db || !authenticatedUserId || !newContactId.trim()) return;

                if (newContactId === authenticatedUserId) {
                    showSystemMessage("Cannot add yourself as a contact.", 'warning');
                    return;
                }

                try {
                    const currentUserContactsRef = window.collection(db, `artifacts/${window.appId}/users/${authenticatedUserId}/contacts`);
                    const q1 = window.query(currentUserContactsRef, window.where("contactId", "==", newContactId));
                    const querySnapshot1 = await window.getDocs(q1);

                    if (querySnapshot1.empty) {
                        await window.addDoc(currentUserContactsRef, {
                            contactId: newContactId,
                            displayName: newContactId,
                            addedAt: window.serverTimestamp(),
                        });
                        console.log(`Contact ${newContactId} added to your list.`);
                        showSystemMessage(`Contact ${newContactId} added to your list.`, 'info');
                        setNewContactId('');
                        setShowAddContactModal(false);
                    } else {
                        console.warn(`Contact ${newContactId} already exists for current user.`);
                        showSystemMessage(`Contact ${newContactId} already exists.`, 'warning');
                    }

                } catch (error) {
                    console.error("Error adding contact:", error);
                    showSystemMessage("Error adding contact. Check console for details.", 'error');
                }
            };

            const handleEditContactName = (contact) => {
                setEditingContact(contact);
                setNewContactDisplayName(contact.displayName || contact.contactId);
                setShowEditContactNameModal(true);
            };

            const handleSaveContactName = async () => {
                // For contacts, we must use the authenticatedUserId for security rules
                if (!db || !authenticatedUserId || !editingContact || !newContactDisplayName.trim()) return;

                try {
                    const contactRef = window.doc(db, `artifacts/${window.appId}/users/${authenticatedUserId}/contacts`, editingContact.id);
                    await window.updateDoc(contactRef, {
                        displayName: newContactDisplayName,
                    });
                    console.log(`Contact ${editingContact.contactId} display name updated to ${newContactDisplayName}`);
                    showSystemMessage(`Contact name updated to ${newContactDisplayName}.`, 'info');
                    setShowEditContactNameModal(false); // Corrected: calling the modal state setter
                    setEditingContact(null);
                    setNewContactDisplayName('');
                } catch (error) {
                    console.error("Error updating contact name:", error);
                    showSystemMessage("Error updating contact name. Check console for details.", 'error');
                }
            };

            const handleDeleteContact = async (contactDocId) => {
                // For contacts, we must use the authenticatedUserId for security rules
                if (!db || !authenticatedUserId || !contactDocId) return;

                setShowConfirmDeleteContactModal(false);
                setContactToDelete(null);

                try {
                    const contactRef = window.doc(db, `artifacts/${window.appId}/users/${authenticatedUserId}/contacts`, contactDocId);
                    await window.deleteDoc(contactRef);
                    console.log(`Contact with ID ${contactDocId} deleted.`);
                    showSystemMessage("Contact deleted successfully.", 'info');

                    if (selectedChat && selectedChat.id === contactDocId) {
                        setSelectedChat(null);
                    }
                } catch (error) {
                    console.error("Error deleting contact:", error);
                    showSystemMessage("Error deleting contact. Check console for details.", 'error');
                }
            };

            const handleDeleteAllContacts = async () => {
                // For contacts, we must use the authenticatedUserId for security rules
                if (!db || !authenticatedUserId) return;

                setShowConfirmDeleteAllContactsModal(false);

                try {
                    const contactsRef = window.collection(db, `artifacts/${window.appId}/users/${authenticatedUserId}/contacts`);
                    const querySnapshot = await window.getDocs(contactsRef);

                    const deletePromises = querySnapshot.docs.map(d => window.deleteDoc(d.ref));
                    await Promise.all(deletePromises);

                    console.log("All contacts deleted.");
                    showSystemMessage("All contacts deleted.", 'info');
                    setContacts([]);
                    setSelectedChat(null);
                } catch (error) {
                    console.error("Error deleting all contacts:", error);
                    showSystemMessage("Error deleting all contacts. Check console for details.", 'error');
                }
            };


            const handleCreateGroup = async () => {
                if (!db || !activeDataUserId || !newGroupName.trim() || selectedGroupMembers.length === 0) {
                    showSystemMessage("Group name, creator, and at least one member are required.", 'warning');
                    return;
                }

                // All members including the creator use activeDataUserId
                const allMembers = Array.from(new Set([...selectedGroupMembers, activeDataUserId]));

                try {
                    const groupsCollectionRef = window.collection(db, `artifacts/${window.appId}/public/data/groups`);
                    await window.addDoc(groupsCollectionRef, {
                        name: newGroupName,
                        members: allMembers,
                        createdBy: activeDataUserId, // createdBy uses activeDataUserId
                        createdAt: window.serverTimestamp(),
                    });
                    showSystemMessage(`Group "${newGroupName}" created successfully!`, 'info');
                    setNewGroupName('');
                    setSelectedGroupMembers([]);
                    setShowCreateGroupModal(false);
                } catch (error) {
                    console.error("Error creating group:", error);
                    showSystemMessage("Error creating group. Check console for details.", 'error');
                }
            };

            const handleToggleGroupMember = (memberId) => {
                setCurrentGroupMembersInModal(prev =>
                    prev.includes(memberId)
                        ? prev.filter(id => id !== memberId)
                        : [...prev, memberId]
                );
            };

            const simulateCall = async (type) => {
                if (!db || !activeDataUserId || !selectedChat || selectedChat.type !== 'individual') return;

                const conversationId = [activeDataUserId, selectedChat.contactId].sort().join('_');
                const messagesCollectionRef = window.collection(db, `artifacts/${window.appId}/public/data/messages/${conversationId}/messages`);

                if (type === 'start') {
                    setCallStatus('calling');
                    try {
                        await window.addDoc(messagesCollectionRef, {
                            senderId: activeDataUserId,
                            receiverId: selectedChat.contactId,
                            text: `Call started with ${selectedChat.contactId}.`,
                            type: 'call_start',
                            timestamp: window.serverTimestamp(),
                        });
                    }
                    catch (error) {
                        console.error("Error sending call start message:", error);
                        showSystemMessage("Error starting call. Check console for details.", 'error');
                    }
                    setTimeout(() => {
                        setCallStatus('in-call');
                        setTimeout(() => {
                            simulateCall('end');
                        }, 5000);
                    }, 2000);
                } else if (type === 'end') {
                    setCallStatus('ended');
                    try {
                        await window.addDoc(messagesCollectionRef, {
                            senderId: activeDataUserId,
                            receiverId: selectedChat.contactId,
                            text: `Call ended with ${selectedChat.contactId}.`,
                            type: 'call_end',
                            timestamp: window.serverTimestamp(),
                        });
                    } catch (error) {
                        console.error("Error sending call end message:", error);
                        showSystemMessage("Error ending call. Check console for details.", 'error');
                    }
                    setTimeout(() => {
                        setCallStatus(null);
                    }, 1500);
                }
            };

            const getAttachmentIcon = (mimeType) => {
                if (mimeType.startsWith('image/')) {
                    return <ImageIcon className="w-4 h-4 mr-1 inline-block" />;
                } else if (mimeType.startsWith('video/')) {
                    return <VideoIcon className="w-4 h-4 mr-1 inline-block" />;
                } else {
                    return <FileTextIcon className="w-4 h-4 mr-1 inline-block" />;
                }
            };

            const handleSaveApiKey = () => {
                localStorage.setItem('geminiApiKey', userApiKey);
                setShowApiKeyModal(false);
                showSystemMessage("Gemini API Key saved locally.", 'info');
            };

            // Function to generate a logo using Imagen API
            const generateLogo = async () => {
                if (!userApiKey) {
                    showSystemMessage('Please enter your Gemini API Key to generate a logo.', 'warning');
                    setShowApiKeyModal(true); // Prompt user to enter API key
                    return;
                }
                setIsLoadingLogo(true);
                const prompt = "minimalist chat app logo, abstract, modern, clean lines, communication icon";
                const payload = { instances: { prompt: prompt }, parameters: { "sampleCount": 1} };
                const apiKey = userApiKey; // Use the user's entered Gemini API Key
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/imagen-3.0-generate-002:predict?key=${apiKey}`;

                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    const result = await response.json();
                    if (response.status === 400 && result.error && result.error.message.includes("Imagen API is only accessible to billed users")) {
                        showSystemMessage("To use the AI Logo generation, your Google Cloud project must have billing enabled for the Imagen API. Please enable billing and try again.", 'error');
                    } else if (result.predictions && result.predictions.length > 0 && result.predictions[0].bytesBase64Encoded) {
                        const imageUrl = `data:image/png;base64,${result.predictions[0].bytesBase64Encoded}`;
                        setLogoUrl(imageUrl);
                        localStorage.setItem('appLogoUrl', imageUrl); // Persist the logo
                        showSystemMessage("AI Logo generated and saved!", 'info');
                    } else {
                        console.error("Image generation failed or response structure unexpected:", result);
                        showSystemMessage("Failed to generate logo. Check console for details and ensure your Gemini API Key is valid and enabled for Image Generation.", 'error');
                    }
                } catch (error) {
                    console.error("Error generating logo:", error);
                    showSystemMessage("Error generating logo. Ensure your Gemini API Key is valid and enabled for Image Generation.", 'error');
                } finally {
                    setIsLoadingLogo(false);
                }
            };

            // Handle background color change
            const handleBackgroundChange = (color) => {
                setBackgroundColor(color);
                setBackgroundImage(''); // Clear image if color is set
                localStorage.setItem('appBackgroundColor', color);
                localStorage.removeItem('appBackgroundImage');
                showSystemMessage("Background color updated.", 'info');
            };

            // Handle background image upload
            const handleBackgroundImgUpload = (event) => {
                const file = event.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        const imageDataUrl = e.target.result;
                        setBackgroundImage(imageDataUrl);
                        setBackgroundColor('transparent'); // Ensure transparent if image
                        localStorage.setItem('appBackgroundImage', imageDataUrl);
                        localStorage.removeItem('appBackgroundColor');
                        showSystemMessage("Background image uploaded.", 'info');
                    };
                    reader.readAsDataURL(file);
                }
            };

            // Clear background settings
            const clearBackground = () => {
                setBackgroundColor('#f1f1f1'); // Reset to default gray
                setBackgroundImage('');
                localStorage.removeItem('appBackgroundColor');
                localStorage.removeItem('appBackgroundImage');
                showSystemMessage("Background cleared to default.", 'info');
            };

            // Handle switching active user ID
            const handleSwitchUserId = () => {
                if (!newPreferredUserIdInput.trim()) {
                    showSystemMessage("Please enter a User ID.", 'warning');
                    return;
                }
                const newId = newPreferredUserIdInput.trim();
                setActiveDataUserId(newId);
                localStorage.setItem('preferredUserId', newId);
                setShowSwitchIdModal(false);
                setNewPreferredUserIdInput('');
                showSystemMessage(`Switched to User ID: ${newId}. Chats will now load/save under this ID.`, 'info');
                // Force a re-fetch of contacts and groups based on the new activeDataUserId
                // React's useEffects will re-run automatically due to activeDataUserId dependency
                setSelectedChat(null); // Clear selected chat to re-initialize messages
            };

            // --- Group Management Functions ---

            // Function to handle opening the delete group confirmation modal
            const handleDeleteGroupClick = (group) => {
                setGroupToDelete(group);
                setShowConfirmDeleteGroupModal(true);
            };

            // Function to delete a group and its subcollection messages
            const handleDeleteGroup = async (groupId) => {
                if (!db || !activeDataUserId || !groupId) return;

                setShowConfirmDeleteGroupModal(false);
                setGroupToDelete(null);

                try {
                    const groupRef = window.doc(db, `artifacts/${window.appId}/public/data/groups`, groupId);
                    const messagesRef = window.collection(db, `artifacts/${window.appId}/public/data/groups/${groupId}/messages`);

                    // Delete all messages in the subcollection first
                    const messageSnapshot = await window.getDocs(messagesRef);
                    if (!messageSnapshot.empty) {
                        const batch = window.writeBatch(db);
                        messageSnapshot.docs.forEach(msgDoc => {
                            batch.delete(msgDoc.ref);
                        });
                        await batch.commit();
                        console.log(`Deleted ${messageSnapshot.docs.length} messages from group ${groupId}`);
                    }

                    // Then delete the group document itself
                    await window.deleteDoc(groupRef);
                    console.log(`Group with ID ${groupId} deleted.`);
                    showSystemMessage(`Group "${groupId}" and its messages deleted successfully.`, 'info');

                    if (selectedChat && selectedChat.id === groupId && selectedChat.type === 'group') {
                        setSelectedChat(null);
                    }
                } catch (error) {
                    console.error("Error deleting group:", error);
                    showSystemMessage("Error deleting group. Check console for details. (Note: Large groups may require more time or backend solution)", 'error');
                }
            };

            // Function to handle opening the edit group members modal
            const handleEditGroupMembersClick = (group) => {
                setEditingGroup(group);
                setCurrentGroupMembersInModal(group.members); // Initialize with current members
                setShowEditGroupMembersModal(true);
            };

            // Function to save changes to group members
            const handleSaveGroupMembers = async () => {
                if (!db || !activeDataUserId || !editingGroup) return;

                // Ensure the activeDataUserId is always included as a member
                const updatedMembers = Array.from(new Set([...currentGroupMembersInModal, activeDataUserId]));

                try {
                    const groupRef = window.doc(db, `artifacts/${window.appId}/public/data/groups`, editingGroup.id);
                    await window.updateDoc(groupRef, {
                        members: updatedMembers,
                    });
                    showSystemMessage(`Group "${editingGroup.name}" members updated!`, 'info');
                    setShowEditGroupMembersModal(false);
                    setEditingGroup(null);
                    setCurrentGroupMembersInModal([]); // Clear modal state
                } catch (error) {
                    console.error("Error updating group members:", error);
                    showSystemMessage("Error updating group members. Check console for details.", 'error');
                }
            };


            if (!isAuthReady || !activeDataUserId) {
                return (
                    <div className="flex items-center justify-center min-h-screen bg-gray-100 font-inter">
                        <div className="text-xl text-gray-700">Loading application...</div>
                    </div>
                );
            }

            return (
                <div className="min-h-screen flex flex-col font-inter text-gray-800">
                    {/* System Message Display */}
                    {systemMessage && (
                        <div className={`fixed bottom-4 right-4 p-4 rounded-lg shadow-lg z-50 text-white ${systemMessage.type === 'error' ? 'bg-red-500' : systemMessage.type === 'warning' ? 'bg-yellow-500' : 'bg-blue-500'}`}>
                            {systemMessage.message}
                        </div>
                    )}

                    {/* Header */}
                    <header className="bg-gradient-to-r from-purple-600 to-indigo-700 text-white p-4 shadow-md rounded-b-lg flex justify-between items-center">
                        <div className="flex items-center">
                            {/* Logo Display Area */}
                            {logoUrl ? (
                                <img src={logoUrl} alt="App Logo" className="w-12 h-12 rounded-full mr-3 border-2 border-white object-cover" />
                            ) : isLoadingLogo ? (
                                <div className="w-12 h-12 rounded-full mr-3 bg-white bg-opacity-30 flex items-center justify-center animate-pulse">
                                    <span className="text-sm">...</span>
                                </div>
                            ) : (
                                <div className="w-12 h-12 rounded-full mr-3 bg-white bg-opacity-30 flex items-center justify-center text-white text-xl font-bold">
                                    G
                                </div>
                            )}
                            <div>
                                <h1 className="text-2xl font-bold">Groups</h1>
                                {/* Display activeDataUserId */}
                                <p className="text-sm mt-1">Active User ID: <span className="font-mono bg-white bg-opacity-20 px-2 py-1 rounded-md">{activeDataUserId}</span></p>
                                <p className="text-sm mt-1">Share this ID with others to connect!</p>
                            </div>
                        </div>
                        <div className="flex space-x-2">
                            {/* AI Logo Generation Button */}
                             <button
                                onClick={generateLogo}
                                className="bg-purple-700 hover:bg-purple-800 text-white text-sm font-bold py-2 px-4 rounded-md shadow-sm transition-all duration-200 ease-in-out transform hover:scale-105 flex items-center"
                                title="Generate AI Logo"
                                disabled={isLoadingLogo}
                            >
                                {isLoadingLogo ? 'Generating...' : <Wand2Icon className="w-5 h-5" />}
                            </button>
                            <button
                                onClick={() => setShowBackgroundSettingsModal(true)}
                                className="bg-purple-700 hover:bg-purple-800 text-white text-sm font-bold py-2 px-4 rounded-md shadow-sm transition-all duration-200 ease-in-out transform hover:scale-105 flex items-center"
                                title="Change Background"
                            >
                                <PaintbrushIcon className="w-5 h-5 mr-2" /> Background
                            </button>
                            {/* Notifications Toggle Button */}
                            <button
                                onClick={toggleNotifications}
                                className={`font-bold py-2 px-4 rounded-md shadow-sm transition-all duration-200 ease-in-out transform hover:scale-105 flex items-center ${
                                    areNotificationsEnabled
                                        ? 'bg-green-500 hover:bg-green-600 text-white'
                                        : 'bg-yellow-500 hover:bg-yellow-600 text-white'
                                }`}
                                title={areNotificationsEnabled ? "Turn Notifications Off" : "Turn Notifications On"}
                            >
                                {areNotificationsEnabled ? <BellIcon className="w-5 h-5 mr-2" /> : <BellOffIcon className="w-5 h-5 mr-2" />}
                                Notifications
                            </button>
                            {/* New Switch User ID Button */}
                            <button
                                onClick={() => setShowSwitchIdModal(true)}
                                className="bg-purple-700 hover:bg-purple-800 text-white text-sm font-bold py-2 px-4 rounded-md shadow-sm transition-all duration-200 ease-in-out transform hover:scale-105 flex items-center"
                                title="Switch User ID"
                            >
                                <UserIcon className="w-5 h-5 mr-2" /> Switch ID
                            </button>
                            <button
                                onClick={() => setShowApiKeyModal(true)}
                                className="bg-purple-700 hover:bg-purple-800 text-white text-sm font-bold py-2 px-4 rounded-md shadow-sm transition-all duration-200 ease-in-out transform hover:scale-105 flex items-center"
                                title="Manage Gemini API Key"
                            >
                                <KeyIcon className="w-5 h-5 mr-2" /> API Key
                            </button>
                        </div>
                    </header>

                    {/* Main Content Area */}
                    <div className="flex flex-1 overflow-hidden p-4">
                        {/* Contacts & Groups List */}
                        <div className="w-1/3 bg-white rounded-l-lg shadow-lg flex flex-col overflow-hidden">
                            <div className="p-4 border-b border-gray-200">
                                <h2 className="text-xl font-semibold mb-3">Chats</h2>
                                <div className="flex space-x-2 mb-3">
                                    <button
                                        onClick={() => setShowAddContactModal(true)}
                                        className="flex-1 bg-blue-500 hover:bg-blue-600 text-white text-sm font-bold py-2 px-4 rounded-md shadow-sm transition-all duration-200 ease-in-out transform hover:scale-105"
                                    >
                                        + Add Contact
                                    </button>
                                    <button
                                        onClick={() => setShowCreateGroupModal(true)}
                                        className="flex-1 bg-purple-500 hover:bg-purple-600 text-white text-sm font-bold py-2 px-4 rounded-md shadow-sm transition-all duration-200 ease-in-out transform hover:scale-105"
                                    >
                                        + Create Group
                                    </button>
                                </div>
                                <button
                                    onClick={() => setShowConfirmDeleteAllContactsModal(true)}
                                    className="w-full bg-red-500 hover:bg-red-600 text-white text-sm font-bold py-2 px-4 rounded-md shadow-sm transition-all duration-200 ease-in-out transform hover:scale-105 mt-2"
                                >
                                    Delete All Contacts
                                </button>
                            </div>
                            <div className="flex-1 overflow-y-auto">
                                {contacts.length === 0 && groups.length === 0 ? (
                                    <p className="p-4 text-gray-500 text-center">No chats yet. Add contacts or create a group!</p>
                                ) : (
                                    <ul>
                                        {/* Individual Contacts */}
                                        {contacts.map((contact) => (
                                            <li
                                                key={contact.id}
                                                className={`p-4 border-b border-gray-100 cursor-pointer hover:bg-gray-50 transition duration-150 ease-in-out ${
                                                  selectedChat && selectedChat.id === contact.id && selectedChat.type === 'individual' ? 'bg-indigo-50 font-medium' : ''
                                                } flex items-center justify-between`}
                                            >
                                                <div className="flex items-center flex-grow" onClick={() => setSelectedChat(contact)}>
                                                    <div className="w-10 h-10 bg-indigo-200 rounded-full flex items-center justify-center text-indigo-800 font-bold text-lg mr-3">
                                                        {(contact.displayName || contact.contactId).substring(0, 2).toUpperCase()}
                                                    </div>
                                                    <span className="truncate">{contact.displayName || contact.contactId}</span>
                                                </div>
                                                <button
                                                    onClick={(e) => {
                                                        e.stopPropagation();
                                                        setContactToDelete(contact);
                                                        setShowConfirmDeleteContactModal(true);
                                                    }}
                                                    className="ml-2 p-1 rounded-full bg-red-100 hover:bg-red-200 text-red-600 transition-colors duration-200"
                                                    title="Delete Contact"
                                                >
                                                    <XIcon className="w-4 h-4" />
                                                </button>
                                            </li>
                                        ))}
                                        {/* Groups */}
                                        {groups.map((group) => (
                                            <li
                                                key={group.id}
                                                onClick={() => setSelectedChat(group)}
                                                className={`p-4 border-b border-gray-100 cursor-pointer hover:bg-gray-50 transition duration-150 ease-in-out ${
                                                  selectedChat && selectedChat.id === group.id && selectedChat.type === 'group' ? 'bg-green-50 font-medium' : ''
                                                }`}
                                            >
                                                <div className="flex items-center">
                                                    <div className="w-10 h-10 bg-green-200 rounded-full flex items-center justify-center text-green-800 font-bold text-lg mr-3">
                                                        <svg className="w-6 h-6" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fillRule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clipRule="evenodd"></path></svg>
                                                    </div>
                                                    <span className="truncate">{group.name}</span>
                                                    <span className="ml-2 text-xs text-gray-500">({group.members.length})</span>
                                                </div>
                                            </li>
                                        ))}
                                    </ul>
                                )}
                            </div>
                        </div>

                        {/* Chat Window */}
                        <div className="w-2/3 bg-white rounded-r-lg shadow-lg flex flex-col">
                            {selectedChat ? (
                                <>
                                    <div className="p-4 border-b border-gray-200 flex justify-between items-center bg-gray-50 rounded-tr-lg">
                                        <h2 className="text-xl font-semibold flex items-center">
                                            {selectedChat.type === 'individual' ? selectedChat.displayName || selectedChat.contactId : `Group: ${selectedChat.name}`}
                                            {selectedChat.type === 'individual' && (
                                                <button
                                                    onClick={() => handleEditContactName(selectedChat)}
                                                    className="ml-2 p-1 rounded-full bg-gray-200 hover:bg-gray-300 text-gray-700 transition-colors duration-200"
                                                    title="Edit Contact Name"
                                                >
                                                    <EditIcon className="w-4 h-4" />
                                                </button>
                                            )}
                                        </h2>
                                        {selectedChat.type === 'individual' && (
                                            <div className="flex space-x-2">
                                                <button
                                                    onClick={() => simulateCall('start')}
                                                    className="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-md shadow-sm transition-all duration-200 ease-in-out transform hover:scale-105 flex items-center"
                                                    disabled={callStatus !== null}
                                                >
                                                    <svg className="w-5 h-5 mr-1" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M2 3a1 1 0 011-1h2.153a1 1 0 01.986.836l.74 4.435a1 1 0 01-.54 1.06l-1.548.774a11.037 11.037 0 006.103 6.103l.774-1.548a1 1 0 011.06-.54l4.435.74a1 1 0 01.836.986V17a1 1 0 01-1 1h-2C7.823 18 2 12.177 2 5V3z"></path></svg>
                                                    Call
                                                </button>
                                            </div>
                                        )}
                                        {selectedChat.type === 'group' && (
                                            <div className="flex space-x-2">
                                                <button
                                                    onClick={() => handleEditGroupMembersClick(selectedChat)}
                                                    className="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-md shadow-sm transition-all duration-200 ease-in-out transform hover:scale-105 flex items-center"
                                                    title="Edit Group Members"
                                                >
                                                    <UsersIcon className="w-5 h-5 mr-1" /> Members
                                                </button>
                                                <button
                                                    onClick={() => handleDeleteGroupClick(selectedChat)}
                                                    className="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-md shadow-sm transition-all duration-200 ease-in-out transform hover:scale-105 flex items-center"
                                                    title="Delete Group"
                                                >
                                                    <Trash2Icon className="w-5 h-5 mr-1" /> Delete
                                                </button>
                                            </div>
                                        )}
                                    </div>

                                    {callStatus && selectedChat.type === 'individual' && (
                                        <div className={`p-2 text-center text-white ${callStatus === 'calling' ? 'bg-yellow-500' : callStatus === 'in-call' ? 'bg-green-500' : 'bg-red-500'} font-medium`}>
                                            {callStatus === 'calling' && 'Calling...'}
                                            {callStatus === 'in-call' && 'In Call'}
                                            {callStatus === 'ended' && 'Call Ended'}
                                        </div>
                                    )}

                                    <div className="flex-1 overflow-y-auto p-4 space-y-3">
                                        {messages.length === 0 ? (
                                            <p className="text-gray-500 text-center mt-10">No messages yet. Start the conversation!</p>
                                        ) : (
                                            messages.map((msg) => (
                                                <div
                                                    key={msg.id}
                                                    className={`flex ${msg.senderId === activeDataUserId ? 'justify-end' : 'justify-start'}`}
                                                >
                                                    <div className={`max-w-xs md:max-w-md px-4 py-2 rounded-xl shadow ${
                                                      msg.senderId === activeDataUserId ? 'bg-blue-500 text-white rounded-br-none' : 'bg-gray-200 text-gray-800 rounded-bl-none'
                                                    }`}>
                                                        {selectedChat.type === 'group' && msg.senderId !== activeDataUserId && (
                                                            <span className="block text-xs font-semibold text-gray-600 mb-1">
                                                              {msg.senderId}
                                                            </span>
                                                        )}
                                                        {msg.type === 'attachment' ? (
                                                            <div className="flex flex-col items-start">
                                                                <div className="flex items-center text-sm font-semibold">
                                                                    {getAttachmentIcon(msg.attachment.type)}
                                                                    <span>Attachment: {msg.attachment.name} ({Math.round(msg.attachment.size / 1024)} KB)</span>
                                                                </div>
                                                                {msg.attachment.data && (
                                                                    <button
                                                                        onClick={() => handleDownloadAttachment(msg.attachment)}
                                                                        className="mt-2 flex items-center px-3 py-1 bg-blue-600 text-white rounded-md text-xs hover:bg-blue-700 transition-colors duration-200"
                                                                    >
                                                                        <DownloadIcon className="w-3 h-3 mr-1" /> Download
                                                                    </button>
                                                                )}
                                                            </div>
                                                        ) : (
                                                            <>
                                                                <p className="text-sm break-words">{msg.text}</p>
                                                                <span className="block text-xs opacity-75 mt-1">
                                                                  {msg.timestamp ? new Date(msg.timestamp.toMillis()).toLocaleTimeString() : 'Sending...'}
                                                                </span>
                                                            </>
                                                        )}
                                                    </div>
                                                </div>
                                            ))
                                        )}
                                        <div ref={messagesEndRef} />
                                    </div>

                                    <div className="p-4 border-t border-gray-200 flex items-center bg-gray-50 rounded-br-lg">
                                        <input
                                            type="text"
                                            value={newMessage}
                                            onChange={(e) => setNewMessage(e.target.value)}
                                            onKeyPress={(e) => {
                                                if (e.key === 'Enter' && newMessage.trim()) handleSendMessage();
                                            }}
                                            className="flex-1 p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-400 focus:border-transparent outline-none transition duration-150 ease-in-out shadow-sm"
                                            placeholder="Type a message..."
                                        />
                                        <input
                                            type="file"
                                            ref={fileInputRef}
                                            onChange={handleFileChange}
                                            className="hidden"
                                        />
                                        <button
                                            onClick={() => fileInputRef.current?.click()}
                                            className="ml-3 bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-3 px-3 rounded-lg shadow-sm transition-all duration-200 ease-in-out transform hover:scale-105 flex items-center justify-center"
                                            title="Attach File"
                                        >
                                            <PaperclipIcon className="w-5 h-5" />
                                        </button>
                                        <button
                                            onClick={() => handleSendMessage()}
                                            className="ml-3 bg-indigo-500 hover:bg-indigo-600 text-white font-bold py-3 px-5 rounded-lg shadow-sm transition-all duration-200 ease-in-out transform hover:scale-105 flex items-center justify-center"
                                            disabled={!newMessage.trim()}
                                        >
                                            <SendIcon className="w-5 h-5" />
                                        </button>
                                    </div>
                                </>
                            ) : (
                                <div className="flex items-center justify-center h-full text-gray-500 text-2xl">
                                    Select a chat to start talking!
                                </div>
                            )}
                        </div>
                    </div>

                    {/* Add Contact Modal */}
                    {showAddContactModal && (
                        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                            <div className="bg-white p-6 rounded-lg shadow-xl w-full max-w-sm transform transition-all duration-300 scale-100 opacity-100">
                                <h3 className="text-xl font-bold mb-4 text-gray-800">Add New Contact</h3>
                                <p className="text-gray-600 mb-4 text-sm">Enter the User ID of the person you want to add.</p>
                                <input
                                    type="text"
                                    value={newContactId}
                                    onChange={(e) => setNewContactId(e.target.value)}
                                    className="w-full p-3 border border-gray-300 rounded-lg mb-4 focus:ring-2 focus:ring-purple-400 focus:border-transparent outline-none transition duration-150 ease-in-out shadow-sm"
                                    placeholder="Enter User ID"
                                />
                                <div className="flex justify-end space-x-3">
                                    <button
                                        onClick={() => setShowAddContactModal(false)}
                                        className="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-md shadow-sm transition-all duration-200 ease-in-out transform hover:scale-105"
                                    >
                                        Cancel
                                    </button>
                                    <button
                                        onClick={handleAddContact}
                                        className="bg-purple-500 hover:bg-purple-600 text-white font-bold py-2 px-4 rounded-md shadow-sm transition-all duration-200 ease-in-out transform hover:scale-105"
                                    >
                                        Add Contact
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Create Group Modal */}
                    {showCreateGroupModal && (
                        <div className="fixed inset-0 bg-black bg-opacity50 flex items-center justify-center z-50">
                            <div className="bg-white p-6 rounded-lg shadow-xl w-full max-w-lg transform transition-all duration-300 scale-100 opacity-100">
                                <h3 className="text-xl font-bold mb-4 text-gray-800">Create New Group</h3>
                                <div className="mb-4">
                                    <label htmlFor="groupName" className="block text-sm font-medium text-gray-700 mb-1">Group Name</label>
                                    <input
                                        type="text"
                                        id="groupName"
                                        value={newGroupName}
                                        onChange={(e) => setNewGroupName(e.target.value)}
                                        className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-400 focus:border-transparent outline-none transition duration-150 ease-in-out shadow-sm"
                                        placeholder="Enter group name"
                                    />
                                </div>
                                <div className="mb-4 max-h-48 overflow-y-auto border border-gray-200 rounded-lg p-2">
                                    <label className="block text-sm font-medium text-gray-700 mb-2">Add Members (from your contacts)</label>
                                    {contacts.length === 0 ? (
                                        <p className="text-gray-500 text-sm italic">No contacts available to add to a group.</p>
                                    ) : (
                                        contacts.map(contact => (
                                            <div key={contact.id} className="flex items-center mb-2">
                                                <input
                                                    type="checkbox"
                                                    id={`member-${contact.id}`}
                                                    checked={selectedGroupMembers.includes(contact.contactId)}
                                                    onChange={() => handleToggleGroupMember(contact.contactId)}
                                                    className="h-4 w-4 text-purple-600 focus:ring-purple-500 border-gray-300 rounded"
                                                />
                                                <label htmlFor={`member-${contact.id}`} className="ml-2 text-gray-700">
                                                    {contact.displayName || contact.contactId}
                                                </label>
                                            </div>
                                        ))
                                    )}
                                </div>
                                <div className="flex justify-end space-x-3">
                                    <button
                                        onClick={() => setShowCreateGroupModal(false)}
                                        className="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-md shadow-sm transition-all duration-200 ease-in-out transform hover:scale-105"
                                    >
                                        Cancel
                                    </button>
                                    <button
                                        onClick={handleCreateGroup}
                                        className="bg-purple-500 hover:bg-purple-600 text-white font-bold py-2 px-4 rounded-md shadow-sm transition-all duration-200 ease-in-out transform hover:scale-105"
                                    >
                                        Create Group
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Confirmation Modal for Delete Single Contact */}
                    {showConfirmDeleteContactModal && contactToDelete && (
                        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                            <div className="bg-white p-6 rounded-lg shadow-xl w-full max-w-sm transform transition-all duration-300 scale-100 opacity-100">
                                <h3 className="text-xl font-bold mb-4 text-gray-800">Confirm Deletion</h3>
                                <p className="text-gray-600 mb-4">Are you sure you want to delete contact "{contactToDelete.displayName || contactToDelete.contactId}"?</p>
                                <div className="flex justify-end space-x-3">
                                    <button
                                        onClick={() => {
                                            setShowConfirmDeleteContactModal(false);
                                            setContactToDelete(null);
                                        }}
                                        className="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-md shadow-sm transition-all duration-200 ease-in-out transform hover:scale-105"
                                    >
                                        Cancel
                                    </button>
                                    <button
                                        onClick={() => handleDeleteContact(contactToDelete.id)}
                                        className="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-md shadow-sm transition-all duration-200 ease-in-out transform hover:scale-105"
                                    >
                                        Delete
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Confirmation Modal for Delete All Contacts */}
                    {showConfirmDeleteAllContactsModal && (
                        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                            <div className="bg-white p-6 rounded-lg shadow-xl w-full max-w-sm transform transition-all duration-300 scale-100 opacity-100">
                                <h3 className="text-xl font-bold mb-4 text-gray-800">Confirm Deletion</h3>
                                <p className="text-gray-600 mb-4">Are you sure you want to delete ALL your contacts? This action cannot be undone.</p>
                                <div className="flex justify-end space-x-3">
                                    <button
                                        onClick={() => setShowConfirmDeleteAllContactsModal(false)}
                                        className="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-md shadow-sm transition-all duration-200 ease-in-out transform hover:scale-105"
                                    >
                                        Cancel
                                    </button>
                                    <button
                                        onClick={handleDeleteAllContacts}
                                        className="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-md shadow-sm transition-all duration-200 ease-in-out transform hover:scale-105"
                                    >
                                        Delete All
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Edit Contact Name Modal */}
                    {showEditContactNameModal && editingContact && (
                        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                            <div className="bg-white p-6 rounded-lg shadow-xl w-full max-w-sm transform transition-all duration-300 scale-100 opacity-100">
                                <h3 className="text-xl font-bold mb-4 text-gray-800">Edit Contact Name</h3>
                                <p className="text-gray-600 mb-4 text-sm">Changing the name for: {editingContact.contactId}</p>
                                <input
                                    type="text"
                                    value={newContactDisplayName}
                                    onChange={(e) => setNewContactDisplayName(e.target.value)}
                                    className="w-full p-3 border border-gray-300 rounded-lg mb-4 focus:ring-2 focus:ring-purple-400 focus:border-transparent outline-none transition duration-150 ease-in-out shadow-sm"
                                    placeholder="Enter new display name"
                                />
                                <div className="flex justify-end space-x-3">
                                    <button
                                        onClick={() => {
                                            setShowEditContactNameModal(false);
                                            setEditingContact(null);
                                            setNewContactDisplayName('');
                                        }}
                                        className="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-md shadow-sm transition-all duration-200 ease-in-out transform hover:scale-105"
                                    >
                                        Cancel
                                    </button>
                                    <button
                                        onClick={handleSaveContactName}
                                        className="bg-purple-500 hover:bg-purple-600 text-white font-bold py-2 px-4 rounded-md shadow-sm transition-all duration-200 ease-in-out transform hover:scale-105"
                                    >
                                        Save Name
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Gemini API Key Modal */}
                    {showApiKeyModal && (
                        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                            <div className="bg-white p-6 rounded-lg shadow-xl w-full max-w-md transform transition-all duration-300 scale-100 opacity-100">
                                <h3 className="text-xl font-bold mb-4 text-gray-800">Manage Gemini API Key</h3>
                                <p className="text-gray-600 mb-4 text-sm">
                                    Enter your Gemini API Key below. This key will be saved locally in your browser.
                                    This key is required for AI features like logo generation.
                                </p>
                                <input
                                    type="password"
                                    value={userApiKey}
                                    onChange={(e) => setUserApiKey(e.target.value)}
                                    className="w-full p-3 border border-gray-300 rounded-lg mb-4 focus:ring-2 focus:ring-purple-400 focus:border-transparent outline-none transition duration-150 ease-in-out shadow-sm"
                                    placeholder="Enter your Gemini API Key here"
                                />
                                <div className="mb-6">
                                    <p className="text-gray-600 text-sm mb-2">Need an API Key?</p>
                                    <a
                                        href="https://ai.google.dev/gemini-api/docs/get-started/api-key"
                                        target="_blank"
                                        rel="noopener noreferrer"
                                        className="inline-flex items-center justify-center bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-md shadow-sm transition-all duration-200 ease-in-out transform hover:scale-105 text-center"
                                    >
                                        Get your Gemini API Key
                                    </a>
                                    <p className="text-red-600 text-xs mt-2">
                                        Note: Imagen API (used for logo generation) requires a Google Cloud project with billing enabled.
                                    </p>
                                </div>
                                <div className="flex justify-end space-x-3">
                                    <button
                                        onClick={() => setShowApiKeyModal(false)}
                                        className="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-md shadow-sm transition-all duration-200 ease-in-out transform hover:scale-105"
                                    >
                                        Cancel
                                    </button>
                                    <button
                                        onClick={handleSaveApiKey}
                                        className="bg-purple-500 hover:bg-purple-600 text-white font-bold py-2 px-4 rounded-md shadow-sm transition-all duration-200 ease-in-out transform hover:scale-105"
                                    >
                                        Save Key
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Background Settings Modal */}
                    {showBackgroundSettingsModal && (
                        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                            <div className="bg-white p-6 rounded-lg shadow-xl w-full max-w-md transform transition-all duration-300 scale-100 opacity-100">
                                <h3 className="text-xl font-bold mb-4 text-gray-800">Customize Background</h3>
                                <div className="mb-4">
                                    <label htmlFor="backgroundColor" className="block text-sm font-medium text-gray-700 mb-2">Choose Background Color:</label>
                                    <input
                                        type="color"
                                        id="backgroundColor"
                                        value={backgroundColor}
                                        onChange={(e) => handleBackgroundChange(e.target.value)}
                                        className="w-full h-10 p-1 border border-gray-300 rounded-lg cursor-pointer shadow-sm"
                                    />
                                </div>
                                <div className="mb-4">
                                    <label htmlFor="backgroundImageUpload" className="block text-sm font-medium text-gray-700 mb-2">Upload Background Image:</label>
                                    <input
                                        type="file"
                                        id="backgroundImageUpload"
                                        accept="image/*"
                                        onChange={handleBackgroundImgUpload}
                                        className="w-full p-2 border border-gray-300 rounded-lg shadow-sm file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100 cursor-pointer"
                                    />
                                </div>
                                {backgroundImage && (
                                    <div className="mb-4">
                                        <p className="text-sm font-medium text-gray-700 mb-2">Current Background Image:</p>
                                        <img src={backgroundImage} alt="Current Background" className="w-full h-32 object-cover rounded-md border border-gray-200" />
                                    </div>
                                )}
                                <div className="flex justify-end space-x-3">
                                    <button
                                        onClick={clearBackground}
                                        className="bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-2 px-4 rounded-md shadow-sm transition-all duration-200 ease-in-out transform hover:scale-105"
                                    >
                                        Clear Background
                                    </button>
                                    <button
                                        onClick={() => setShowBackgroundSettingsModal(false)}
                                        className="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-md shadow-sm transition-all duration-200 ease-in-out transform hover:scale-105"
                                    >
                                        Close
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Switch User ID Modal */}
                    {showSwitchIdModal && (
                        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                            <div className="bg-white p-6 rounded-lg shadow-xl w-full max-w-sm transform transition-all duration-300 scale-100 opacity-100">
                                <h3 className="text-xl font-bold mb-4 text-gray-800">Switch User ID</h3>
                                <p className="text-gray-600 mb-4 text-sm">
                                    Enter the User ID you wish to use for chats and groups. This will persist across sessions.
                                    <br/><br/>
                                    <span className="font-semibold text-red-600">Note:</span> If this ID is different from your current authenticated Firebase ID ({authenticatedUserId || 'loading...'}), your private contacts (added contacts list) might not be accessible for writing/reading due to Firebase security rules. Group chats and individual messages will still function normally with the entered ID.
                                </p>
                                <input
                                    type="text"
                                    value={newPreferredUserIdInput}
                                    onChange={(e) => setNewPreferredUserIdInput(e.target.value)}
                                    className="w-full p-3 border border-gray-300 rounded-lg mb-4 focus:ring-2 focus:ring-purple-400 focus:border-transparent outline-none transition duration-150 ease-in-out shadow-sm"
                                    placeholder="Enter previous User ID"
                                />
                                <div className="flex justify-end space-x-3">
                                    <button
                                        onClick={() => setShowSwitchIdModal(false)}
                                        className="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-md shadow-sm transition-all duration-200 ease-in-out transform hover:scale-105"
                                    >
                                        Cancel
                                    </button>
                                    <button
                                        onClick={handleSwitchUserId}
                                        className="bg-purple-500 hover:bg-purple-600 text-white font-bold py-2 px-4 rounded-md shadow-sm transition-all duration-200 ease-in-out transform hover:scale-105"
                                    >
                                        Switch ID
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Confirmation Modal for Delete Group */}
                    {showConfirmDeleteGroupModal && groupToDelete && (
                        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                            <div className="bg-white p-6 rounded-lg shadow-xl w-full max-w-sm transform transition-all duration-300 scale-100 opacity-100">
                                <h3 className="text-xl font-bold mb-4 text-gray-800">Confirm Group Deletion</h3>
                                <p className="text-gray-600 mb-4">
                                    Are you sure you want to delete the group "{groupToDelete.name}"?
                                    This will permanently delete the group and ALL its messages for everyone. This action cannot be undone.
                                </p>
                                <div className="flex justify-end space-x-3">
                                    <button
                                        onClick={() => {
                                            setShowConfirmDeleteGroupModal(false);
                                            setGroupToDelete(null);
                                        }}
                                        className="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-md shadow-sm transition-all duration-200 ease-in-out transform hover:scale-105"
                                    >
                                        Cancel
                                    </button>
                                    <button
                                        onClick={() => handleDeleteGroup(groupToDelete.id)}
                                        className="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-md shadow-sm transition-all duration-200 ease-in-out transform hover:scale-105"
                                    >
                                        Delete Group
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Edit Group Members Modal */}
                    {showEditGroupMembersModal && editingGroup && (
                        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                            <div className="bg-white p-6 rounded-lg shadow-xl w-full max-w-lg transform transition-all duration-300 scale-100 opacity-100">
                                <h3 className="text-xl font-bold mb-4 text-gray-800">Edit Members for "{editingGroup.name}"</h3>
                                <div className="mb-4 max-h-60 overflow-y-auto border border-gray-200 rounded-lg p-2">
                                    <p className="text-sm font-medium text-gray-700 mb-2">Select members:</p>
                                    {/* Current active user is always a member and cannot be removed */}
                                    <div className="flex items-center mb-2">
                                        <input
                                            type="checkbox"
                                            id={`member-${activeDataUserId}`}
                                            checked={true} // Always checked
                                            disabled // Cannot be unchecked
                                            className="h-4 w-4 text-green-600 focus:ring-green-500 border-gray-300 rounded"
                                        />
                                        <label htmlFor={`member-${activeDataUserId}`} className="ml-2 text-gray-700 font-bold">
                                            {activeDataUserId} (You - Creator)
                                        </label>
                                    </div>
                                    {/* Other contacts/members */}
                                    {contacts.filter(c => c.contactId !== activeDataUserId).length === 0 && editingGroup.members.filter(m => m !== activeDataUserId).length === 0 ? (
                                        <p className="text-gray-500 text-sm italic">No other contacts or members to manage.</p>
                                    ) : (
                                        [...new Set([...contacts.map(c => c.contactId), ...editingGroup.members])].sort().map(memberId => {
                                            // Skip if it's the active user, as they are handled separately
                                            if (memberId === activeDataUserId) return null;

                                            const isChecked = currentGroupMembersInModal.includes(memberId);
                                            const displayName = contacts.find(c => c.contactId === memberId)?.displayName || memberId;

                                            return (
                                                <div key={memberId} className="flex items-center mb-2">
                                                    <input
                                                        type="checkbox"
                                                        id={`edit-member-${memberId}`}
                                                        checked={isChecked}
                                                        onChange={() => handleToggleGroupMember(memberId)}
                                                        className="h-4 w-4 text-purple-600 focus:ring-purple-500 border-gray-300 rounded"
                                                    />
                                                    <label htmlFor={`edit-member-${memberId}`} className="ml-2 text-gray-700">
                                                        {displayName}
                                                    </label>
                                                </div>
                                            );
                                        })
                                    )}
                                </div>
                                <div className="flex justify-end space-x-3">
                                    <button
                                        onClick={() => {
                                            setShowEditGroupMembersModal(false);
                                            setEditingGroup(null);
                                            setCurrentGroupMembersInModal([]);
                                        }}
                                        className="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-md shadow-sm transition-all duration-200 ease-in-out transform hover:scale-105"
                                    >
                                        Cancel
                                    </button>
                                    <button
                                        onClick={handleSaveGroupMembers}
                                        className="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-md shadow-sm transition-all duration-200 ease-in-out transform hover:scale-105"
                                    >
                                        Save Changes
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        // Render the App component using React 18's createRoot
        const container = document.getElementById('root');
        const root = createRoot(container);
        root.render(<App />);
    </script>
</body>
</html>
